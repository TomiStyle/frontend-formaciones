<app-navbar [user]="user"></app-navbar>
<app-loading-overlay [show]="loading"></app-loading-overlay>

<div class="formation-content">

    <!-- Bloque con datos de la formación -->
    <div *ngIf="!loading && formation" class="formation-container">
        <mat-card class="formation-header">
            <mat-card-header>
                <mat-card-title>{{ formation.title }}</mat-card-title>
                <mat-card-subtitle>
                    Fecha: {{ formatDate(formation.date) }} |
                    Columnas: {{ formation.num_columns }} |
                    Total personas: {{ getTotalPeople() }}
                </mat-card-subtitle>
            </mat-card-header>
            <mat-card-actions>
                <button mat-raised-button color="primary" (click)="goBack()">
                    <mat-icon>arrow_back</mat-icon>
                    Volver
                </button>

                <span class="spacer"></span>

                <button mat-icon-button matTooltip="Descargar PDF por filas" (click)="downloadPdfByRows()">
                    <mat-icon>picture_as_pdf</mat-icon>
                </button>

                <!-- <button mat-icon-button matTooltip="Descargar Excel por filas" (click)="downloadExcelByRows()">
                    <mat-icon>description</mat-icon>
                </button> -->
            </mat-card-actions>
        </mat-card>

        <!-- Combo para seleccionar filas -->
        <div class="row-selector">
            <mat-form-field appearance="outline">
                <mat-label>Selecciona fila</mat-label>
                <mat-select [(ngModel)]="selectedRow">
                    <mat-option value="all">Todas</mat-option>
                    <!-- Por defecto se marca esta opción, ya que de primeras saldrán todas las filas visibles -->
                    <!-- Recorremos las filas y montamos el combo -->
                    <mat-option *ngFor="let row of rows" [value]="row.rowNumber">
                        Fila {{ row.rowNumber }}
                    </mat-option>
                </mat-select>
            </mat-form-field>
        </div>

        <!-- Bloque para las tablas de las filas -->
        <div class="formation-list-tables">
            <!-- Por cada fila montamos una tabla -->
            <mat-card *ngFor="let row of getRowsToShow()" class="row-table-card">
                <div class="table-title">Fila {{ row.rowNumber }}</div>
                <table class="people-table">
                    <thead>
                        <tr>
                            <th>Columna</th>
                            <th>Nombre</th>
                            <th>Apellidos</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Añadimos una fila por cada persona asignada en la fila -->
                        <tr *ngFor="let person of row.people; trackBy: trackByPersonId" class="clickable-row"
                            (click)="openPersonModal(person)">
                            <td>{{ person.column }}</td>
                            <td>{{ person.name }}</td>
                            <td>{{ person.surname }}</td>
                        </tr>
                        <!-- Por si acaso, controlamos que la fila no tenga personas, no obstante no se debería dar -->
                        <tr *ngIf="row.people.length === 0">
                            <td colspan="3" class="empty-cell">
                                <mat-icon>person_off</mat-icon>
                                Sin personas asignadas
                            </td>
                        </tr>
                    </tbody>
                </table>
            </mat-card>
        </div>
    </div>

    <!-- Bloque de error -->
    <div *ngIf="!loading && !formation" class="error-container">
        <mat-card>
            <mat-card-content>
                <div class="error-content">
                    <mat-icon color="warn">error</mat-icon>
                    <h3>No se pudo cargar la formación</h3>
                    <p>
                        Verifica que el ID de la formación sea correcto y que tengas permisos para acceder.
                    </p>
                    <button mat-raised-button color="primary" (click)="goBack()">
                        <mat-icon>arrow_back</mat-icon>
                        Volver al listado
                    </button>
                </div>
            </mat-card-content>
        </mat-card>
    </div>
</div>

<!-- Modal para mostrar la información de una persona al hacer clic -->
<app-person-detail-modal [isOpen]="isPersonModalOpen" [person]="selectedPerson" [numRows]="maxRows"
    [numColumns]="formation?.num_columns || 0" [allPeople]="allPeople" (closeModal)="closePersonModal()"
    (confirmSwap)="handleConfirmSwap($event)" (removePerson)="handleRemovePerson($event)"
    (addPerson)="handleAddPerson($event)">
</app-person-detail-modal>